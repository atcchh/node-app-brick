var http = require('http');
var https = require('https');
var URL = require('url');

var Q = require('q');



var _request = function(urlString, method, data, setHeader) {
	var deferred = Q.defer();
	var url = URL.parse(urlString);
	var options = {
		hostname: url.hostname,
		port: url.protocol === 'http:'? 80:443,
		path: url.path,
		method: method,
		headers:{
			'Content-Type': method === 'POST'? 'application/x-www-form-urlencoded' :'application/json; charset=utf-8',
			Connection:'close',
		}
	};
	if(setHeader) {
		options.headers = setHeader(options.headers);
	}
	var protocol = (url.protocol === 'http:'? http:https);
	var req = https.request(options, function(res) {
		if(res.statusCode != 200){
			deferred.reject(new Error('visit [' + method + '--->'+urlString + ']  response  status is [' + res.statusCode + '], please check it'));
			return;
		} 

		res.setEncoding('utf8');
		var buffer = '';
		res.on('data', function (chunk) {
			buffer += chunk;
		});
		try {
			res.on('end', function () {
				deferred.resolve(JSON.parse(buffer));
			});
		} catch(e) {
			deferred.reject(new Error(e));
		}	
	});

	req.on('error', function(e) {
		deferred.reject(new Error(e));
	});

	// write data to request body
	var responseData = '';
	if(data) {
		for(var a in data) {
			responseData += encodeURIComponent(a)+'='+encodeURIComponent(data[a]) + '&';
		}
	}

	req.end(responseData);
	return deferred.promise;
};

var get = function(urlString, data, setHeader) {
	return _request(urlString, 'GET', data, setHeader);
};

var post = function(urlString, data, setHeader) {
	return _request(urlString, 'POST', data, setHeader);
};
module.exports.get=get;
module.exports.post=post;



