var https = require('https');
var fs =require('fs');

var parseCookies = require('cookie');

var RestfulClient = require('./restClient.js')
var FileUtils = require('./fileUtils');
var httpUtils = require('./httpUtils');


var lufaxConfigFile = '/tmp/lufax.conf';
var prefixIMVC = '/tmp/imvc/';


FileUtils.readLastLine(lufaxConfigFile).then(function(lastLine){
	if(isCreateNewCookie(lastLine)){
		//save the picture
		var fileName = prefixIMVC + new Date().getTime() + '.png';
		var IMVC = '';
		httpUtils.downloadFile("https://user.lufax.com/user/captcha/captcha.jpg?source=login&_=" + new Date().getTime(), fileName).then(function(res){
			IMVC = getCookie(res,'IMVC');
			var param = {};
			param.username = 'rfvbgtyuxx7';
			param.password = '2C6932BF3FAE29FE629794B431F44593';
			param.typeid = '3040';
			param.softid = '6865';
			param.softkey = 'c009a96f01a622653fea46e324a3d4ce';
			return httpUtils.uploadFile("http://api.ruokuai.com/create.json",param,fileName)
		}).then(function(data){
			var jsonData = JSON.parse(data);
			var param = {};
			param.password='1290127EFBDC4D8607F776C1370D1FAF1ED3ADD200C883C4111F8D6D3EE7C837A58E0608582A3A79E9ABC3FFA54993010ACC1891E74EBC18B2DA8C2922A0C22887695BCC66F169AC6885F9654B0C99EFCB71888CC158C687CDCBA36A1F40496F1B892C7DC29F2C4A5B4417D90E83EC20FD45D628E6093087F12672D7DEF8CF30';
			param.userNameLogin='oneforce';
			param.pwd='************';
			param.validNum=jsonData.Result;
			return RestfulClient.post("https://user.lufax.com/user/login",param, function(headers){
				headers['Cookie']='IMVC='+IMVC;
				return headers;
			});
		}).then(function(data){
			fs.appendFileSync(lufaxConfigFile,'www.lufax.com:::'+new Date().getTime() + ':::'+new Date().getTime() + ':::' + data.sessionId + '\n');
		});
	} else {
		var lufaxSID = lastLine.split(':::')[3];
		var createTime = lastLine.split(':::')[1];
		var keepSessionRequest = https.request({'host':'user.lufax.com',//远端服务器域名
			'port':443,//远端服务器端口号
			'method':'GET',
			'path':'/user/keepSession.gif',//
			'headers':{
				'Connection':'close',
				'Cookie':'_lufaxSID="' + lufaxSID + '"'
			}}, function(keepSessionResponse){
				keepSessionRequest.end();
				console.log(lufaxSID);
				fs.appendFileSync(lufaxConfigFile,'www.lufax.com:::'+createTime + ':::'+new Date().getTime() + ':::' + lufaxSID + '\n');
				console.log('keep session succes');
				keepSessionResponse.on('close', function(){
					console.log('response close');
				});
			});
		keepSessionRequest.end();
	}
});


var isCreateNewCookie = function(line) {
	if(!line) {
		return true;
	}
	var field = line.split(':::');
	var createTime = field[1];
	var lastUpdateTime = field[2];
	if(new Date().getTime() - createTime > 6 * 60 * 60 * 1000) {
		return true;
	} else 	if(new Date().getTime() - lastUpdateTime > 10 * 60 * 1000) {
		return true;
	} else {
		return false;
	}
	// TODO check the _lufaxSID is valid or not
}
var getCookie = function(response, cookieName) {
	var cookies = response.headers['set-cookie'];
	for(var index =0; index < cookies.length; index++) {

		var cookie = parseCookies.parse(cookies[index]);
		if(cookie[cookieName]) {
			return cookie[cookieName];
		}
	}
	return null;

}
